#!/usr/bin/env ruby

require "docopt"

begin
  cli = Docopt.docopt(<<~DOCOPT)
    Usage:
      wal watch --watcher <watcher-class>
        (--slot <replication-slot> | --tmp-slot)
        --publication <publication>...
        [--replicator <replicator-class>]
      wal start <config-file>

    Options:
      -h --help                          Show this screen.
      --watcher=<watcher-class>          The watcher class to be used to listen for WAL changes.
      --slot=<replication-slot>          The replication slot that will be used.
      --tmp-slot                         Use a temporary replication slot.
      [--publication=<publication>...]   Postgres publications to subscribe to.
      [--replicator=<replicatior_class>] Change the replication driver class
  DOCOPT
rescue Docopt::Exit => err
  puts err.message
  exit
end

require "./config/environment"

db_config = ActiveRecord::Base.configurations.configs_for(name: "primary").configuration_hash

if cli["watch"]
  config = {
    "watcher" => cli["--watcher"],
    "temporary" => cli["--tmp-slot"],
    "publications" => cli["--publication"] || [],
    "replicator" => cli["--replicator"],
  }
  slot = cli["--slot"].presence || "wal_watcher_#{SecureRandom.alphanumeric(4)}"
  runner = Wal::Runner.new(config: { "slots" => { slot => config } }, db_config:)
  runner.start
elsif cli["start"]
  config = YAML.load_file(cli["<config-file>"])
  runner = Wal::Runner.new(config:, db_config:)
  runner.start
end
